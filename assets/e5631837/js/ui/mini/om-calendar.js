(function(e){e.omWidget("om.omCalendar",{options:{date:new Date,startDay:0,pages:1,minDate:!1,maxDate:!1,popup:!0,showTime:!1,onSelect:function(e,t){},disabledDays:[],disabledFn:function(e){},disabled:!1,readOnly:!1,editable:!0,dateFormat:!1},disable:function(){this.options.popup&&(this.hide(),this.options.disabled=!0,this.element.attr("disabled",!0).unbind(".omCalendar").next().addClass("om-state-disabled").unbind())},enable:function(){this.options.popup&&(this.options.disabled=!1,this.element.attr("disabled",!1).next().removeClass("om-state-disabled"),this._buildStatusEvent())},getDate:function(){return this.options.date},setDate:function(e){this.options.date=e,this._render({date:e})},_create:function(){var t=this.element,n=this.options;this.cid=this._stamp(t),n.popup?(t.wrap("<span></span>").after('<span class="om-calendar-trigger"></span>').parent().addClass("om-calendar om-widget om-state-default").css({position:"relative"}),this.con=e("<div></div>").appendTo(t.parent()).css({top:"0px",position:"absolute",background:"white",visibility:"hidden","z-index":"2000"}),this._buildBodyEvent(),this._buildStatusEvent()):this.con=this.element,this.con.addClass("om-calendar-list-wrapper om-widget om-clearfix om-widget-content")},_init:function(){var t=this.element,n=this.options;this.con.addClass("multi-"+n.pages),this._buildParam(),n.popup&&t.val()&&(n.date=e.omCalendar.parseDate(t.val(),n.dateFormat||this._defaultFormat)||new Date),this._render(),n.readOnly||!n.editable?t.attr("readonly","readOnly").unbind():t.removeAttr("readonly"),n.disabled?this.disable():this.enable()},_render:function(t){var n=0,r,i,s,o=this.element,u=this.options;this.ca=[],this._parseParam(t),this.con.html("");for(n=0,s=[this.year,this.month];n<u.pages;n++)n===0?r=!0:(r=!1,s=this._computeNextMonth(s)),i=n==u.pages-1,this.ca.push(new e.om.omCalendar.Page({year:s[0],month:s[1],prevArrow:r,nextArrow:i,showTime:self.showTime},this)),this.ca[n]._render();if(u.pages>1){var a=o.find(".om-cal-box"),f=[];e.each(a,function(t,n){f.push(e(n).css("height"))}),f.sort(),a.css("height",f[f.length-1])}},_stamp:function(e){return(e.attr("id")===undefined||e.attr("id")==="")&&e.attr("id","K_"+(new Date).getTime()),e.attr("id")},_buildStatusEvent:function(){var t=this;this.element.unbind(".omCalendar").bind("click.omCalendar",function(e){t.toggle()}).bind("focus.omCalendar",function(){e(this).parent().addClass("om-state-hover om-state-active")}).bind("blur.omCalendar",function(){e(this).parent().removeClass("om-state-hover om-state-active")}).next().unbind().click(function(){t.element.trigger("focus"),t.show()}).mouseover(function(){e(this).parent().addClass("om-state-hover")}).mouseout(function(){!t.isVisible()&&e(this).parent().removeClass("om-state-hover")})},_buildBodyEvent:function(){var t=this;e(document).bind("mousedown.omCalendar",this.globalEvent=function(e){t.hide()}),t.con.mousedown(function(e){e.stopPropagation()})},toggle:function(){this.isVisible()?this.hide():this.show()},isVisible:function(){return this.con.css("visibility")=="hidden"?!1:!0},show:function(){var e=this.element.parent();this.con.css("visibility","");var t=e.offset().left,n=e.offsetHeight||e.outerHeight();this.con.css("left","-1px"),this.con.css("top",e.outerHeight())},hide:function(){this.con.css("visibility","hidden")},destroy:function(){var t=this.element;e("body").unbind(".omCalendar",this.globalEvent),this.options.popup&&(t.parent().after(t).remove(),this.con.remove())},_buildParam:function(){var e=this.options;return e.startDay&&(e.startDay=(7-e.startDay)%7),!e.dateFormat&&(this._defaultFormat=e.showTime?"yy-mm-dd H:i:s":"yy-mm-dd"),this.EV=[],this},_parseParam:function(t){t&&e.extend(this.options,t),this._handleDate()},_templetShow:function(e,t){var n,r,i,s,o,u;if(t instanceof Array){n="";for(i=0;i<t.length;i++)n+=arguments.callee(e,t[i]);e=n}else{r=e.match(/{\$(.*?)}/g);if(t!==undefined&&r!==null)for(i=0,s=r.length;i<s;i++)u=r[i].replace(/({\$)|}/g,""),o=t[u]!==undefined?t[u]:"",e=e.replace(r[i],o)}return e},_handleDate:function(){var e=this.options.date;this.day=e.getDate(),this.month=e.getMonth(),this.year=e.getFullYear()},_getHeadStr:function(t,n){return t.toString()+e.om.lang.omCalendar.year+(Number(n)+1).toString()+e.om.lang.omCalendar.month},_monthAdd:function(){var e=this;return e.month==11?(e.year++,e.month=0):e.month++,e.options.date.setFullYear(e.year,e.month,1),this},_monthMinus:function(){var e=this;return e.month===0?(e.year--,e.month=11):e.month--,e.options.date.setFullYear(e.year,e.month,1),this},_computeNextMonth:function(e){var t=e[0],n=e[1];return n==11?(t++,n=0):n++,[t,n]},_handleOffset:function(){var t=this,n=e.om.lang.omCalendar,r=[n.Su,n.Mo,n.Tu,n.We,n.Th,n.Fr,n.Sa],i="<span>{$day}</span>",s=this.options.startDay,o="",u=[];for(var a=0;a<7;a++)u[a]={day:r[(a-s+7)%7]};return o=t._templetShow(i,u),{day_html:o}}}),e.extend(e.om.omCalendar,{Page:function(t,n){var r=e.om.lang.omCalendar;this.father=n,this.month=Number(t.month),this.year=Number(t.year),this.prevArrow=t.prevArrow,this.nextArrow=t.nextArrow,this.node=null,this.timmer=null,this.id="",this.EV=[],this.html=['<div class="om-cal-box" id="{$id}">','<div class="om-cal-hd om-widget-header">','<a href="javascript:void(0);" class="om-prev {$prev}"><span class="om-icon om-icon-seek-prev">Prev</span></a>','<a href="javascript:void(0);" class="om-title">{$title}</a>','<a href="javascript:void(0);" class="om-next {$next}"><span class="om-icon om-icon-seek-next">Next</span></a>',"</div>",'<div class="om-cal-bd">','<div class="om-whd">',n._handleOffset().day_html,"</div>",'<div class="om-dbd om-clearfix">',"{$ds}","</div>","</div>",'<div class="om-setime om-state-default hidden">',"</div>",'<div class="om-cal-ft {$showtime}">','<div class="om-cal-time om-state-default">',"时间:00:00 &hearts;","</div>","</div>",'<div class="om-selectime om-state-default hidden">',"</div>","</div><!--#om-cal-box-->"].join(""),this.nav_html=["<p>",r.month,'<select value="{$the_month}">','<option class="m1" value="1">01</option>','<option class="m2" value="2">02</option>','<option class="m3" value="3">03</option>','<option class="m4" value="4">04</option>','<option class="m5" value="5">05</option>','<option class="m6" value="6">06</option>','<option class="m7" value="7">07</option>','<option class="m8" value="8">08</option>','<option class="m9" value="9">09</option>','<option class="m10" value="10">10</option>','<option class="m11" value="11">11</option>','<option class="m12" value="12">12</option>',"</select>","</p>","<p>",r.year,'<input type="text" value="{$the_year}" onfocus="this.select()"/>',"</p>","<p>",'<button class="ok" type="button">',r.ok,'</button><button class="cancel" type="button">',r.cancel,"</button>","</p>"].join(""),this.Verify=function(){var e=function(e){return/^\d+$/i.test(e)?(e=Number(e),!(e<1||e>31)):!1},t=function(e){return/^\d+$/i.test(e)?(e=Number(e),!(e<100||e>1e4)):!1},n=function(e){return/^\d+$/i.test(e)?(e=Number(e),!(e<1||e>12)):!1};return{isDay:e,isYear:t,isMonth:n}},this._renderUI=function(){var t=this,n={},r,i=t.father.options;return t.HTML="",n.prev="",n.next="",n.title="",n.ds="",t.prevArrow||(n.prev="hidden"),t.nextArrow||(n.next="hidden"),t.father.showTime||(n.showtime="hidden"),n.id=t.id="om-cal-"+Math.random().toString().replace(/.\./i,""),n.title=t.father._getHeadStr(t.year,t.month),t.createDS(),n.ds=t.ds,t.father.con.append(t.father._templetShow(t.html,n)),t.node=e("#"+t.id),i.showTime&&(r=t.node.find(".om-cal-ft"),r.removeClass("hidden"),t.timmer=new e.om.omCalendar.TimeSelector(r,t.father)),this},this._buildEvent=function(){var t=this,n,r=e("#"+t.id),i=t.father.options;t.EV[0]=r.find("div.om-dbd").bind("mousedown",function(n){var r=e(n.target);if(r.filter(".om-null, .om-state-disabled").length>0)return;var s=Number(r.html()),o=new Date(i.date);o.setFullYear(t.year,t.month,s),t.father.dt_date=o,i.showTime||t.father._trigger("onSelect",n,o);if(i.popup&&!i.showTime){t.father.hide();if(!isNaN(t.father.dt_date)){var u=e.omCalendar.formatDate(t.father.dt_date,i.dateFormat||t.father._defaultFormat);e(t.father.element).val(u).focus().blur()}}t.father._render({date:o})}).find("a").bind("mouseover",function(t){e(this).addClass("om-state-hover om-state-nobd")}).bind("mouseout",function(t){e(this).removeClass("om-state-hover").not(".om-state-highlight, .om-state-active").removeClass("om-state-nobd")}),t.EV[1]=r.find("a.om-prev").bind("click",function(e){return t.father._monthMinus()._render(),!1}),t.EV[2]=r.find("a.om-next").bind("click",function(e){return t.father._monthAdd()._render(),!1}),t.EV[3]=r.find("a.om-title").bind("click",function(n){try{t.timmer.hidePopup()}catch(i){}var s=e(n.target),o=t.father._templetShow(t.nav_html,{the_month:t.month+1,the_year:t.year});return r.find(".om-setime").html(o).removeClass("hidden").find("option:[value="+(t.month+1)+"]").attr("selected","selected"),this.blur(),r.find("input").bind("keydown",function(n){var i=e(n.target);n.keyCode==e.om.keyCode.UP&&(i.val(Number(i.val())+1),i[0].select()),n.keyCode==e.om.keyCode.DOWN&&(i.val(Number(i.val())-1),i[0].select());if(n.keyCode==e.om.keyCode.ENTER){var s=r.find(".om-setime select").val(),o=r.find(".om-setime input").val();r.find(".om-setime").addClass("hidden");if(!t.Verify().isYear(o))return;if(!t.Verify().isMonth(s))return;t.father._render({date:t._computeDate(t,o,s)})}}),!1}).bind("mouseover",function(t){e(this).addClass("om-state-hover")}).bind("mouseout",function(t){e(this).removeClass("om-state-hover")}),t.EV[4]=r.find(".om-setime").bind("click",function(n){n.preventDefault();var r=e(n.target),i=e(this);if(r.hasClass("ok")){var s=i.find("select").val(),o=i.find("input").val();i.addClass("hidden");if(!t.Verify().isYear(o))return;if(!t.Verify().isMonth(s))return;s=s-i.parent().prevAll(".om-cal-box").length-1,t.father._render({date:t._computeDate(t,o,s)})}else r.hasClass("cancel")&&i.addClass("hidden")})},this._computeDate=function(e,t,n){var r=new Date(e.father.options.date.getTime());return r.setFullYear(t,n),r},this._getNode=function(){var e=this;return e.node},this._getNumOfDays=function(e,t){return 32-(new Date(e,t-1,32)).getDate()},this.createDS=function(){var t=this,n=t.father.options,r="",i=((new Date(t.year+"/"+(t.month+1)+"/01")).getDay()+n.startDay+7)%7,s=t._getNumOfDays(t.year,t.month+1)+i,o,u,a=[];for(o=0;o<n.disabledDays.length;o++)a[o]=n.disabledDays[o]%7;for(o=0;o<s;o++){var f=new Date(t.year+"/"+Number(t.month+1)+"/"+(o+1-i).toString());o<i?r+='<a href="javascript:void(0);" class="om-null" >0</a>':e.inArray((o+n.startDay)%7,a)>=0?r+='<a href="javascript:void(0);" class="om-state-disabled">'+(o-i+1)+"</a>":n.disabledFn(f)===!1?r+='<a href="javascript:void(0);" class="om-state-disabled">'+(o-i+1)+"</a>":n.minDate instanceof Date&&(new Date(t.year+"/"+(t.month+1)+"/"+(o+1-i))).getTime()<n.minDate.getTime()+1?r+='<a href="javascript:void(0);" class="om-state-disabled">'+(o-i+1)+"</a>":n.maxDate instanceof Date&&(new Date(t.year+"/"+(t.month+1)+"/"+(o+1-i))).getTime()>n.maxDate.getTime()?r+='<a href="javascript:void(0);" class="om-state-disabled">'+(o-i+1)+"</a>":o==i+(new Date).getDate()-1&&(new Date).getFullYear()==t.year&&(new Date).getMonth()==t.month?r+='<a href="javascript:void(0);" class="om-state-highlight om-state-nobd">'+(o-i+1)+"</a>":o==i+n.date.getDate()-1&&t.month==n.date.getMonth()&&t.year==n.date.getFullYear()?r+='<a href="javascript:void(0);" class="om-state-active om-state-nobd">'+(o-i+1)+"</a>":r+='<a href="javascript:void(0);">'+(o-i+1)+"</a>"}if(s%7!==0)for(o=0;o<7-s%7;o++)r+='<a href="javascript:void(0);" class="om-null">0</a>';t.ds=r},this._render=function(){var e=this;e._renderUI(),e._buildEvent()}}}),e.extend(e.om.omCalendar,{TimeSelector:function(t,n){var r=n.options.date,i=e.om.lang.omCalendar;this.father=n,this.fcon=t.parent(".om-cal-box"),this.popupannel=this.fcon.find(".om-selectime"),typeof r=="undefined"&&(n.options.date=new Date),this.time=n.options.date,this.status="s",this.ctime=e('<div class="om-cal-time om-state-default">'+i.time+':<span class="h">h</span>:<span class="m">m</span>:<span class="s">s</span><!--{{arrow--><div class="cta"><button class="u om-icon om-icon-triangle-1-n" type="button"></button><button class="d om-icon om-icon-triangle-1-s" type="button"></button></div><!--arrow}}--></div>'),this.button=e('<button class="ct-ok om-state-default" type="button">'+i.ok+"</button>"),this.h_a=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"],this.m_a=["00","10","20","30","40","50"],this.s_a=["00","10","20","30","40","50"],this.parseSubHtml=function(e){var t="";for(var n=0;n<e.length;n++)t+='<a href="javascript:void(0);" class="om-cal-item">'+e[n]+"</a>";return t+='<a href="javascript:void(0);" class="x">x</a>',t},this.showPopup=function(e){var t=this;this.popupannel.html(e),this.popupannel.removeClass("hidden");var n=t.status,r="om-state-active om-state-nobd";t.ctime.find("span").removeClass(r);switch(n){case"h":t.ctime.find(".h").addClass(r);break;case"m":t.ctime.find(".m").addClass(r);break;case"s":t.ctime.find(".s").addClass(r)}},this.hidePopup=function(){this.popupannel.addClass("hidden")},this._render=function(){var e=this,t=e.get("h"),n=e.get("m"),r=e.get("s");return e.father._time=e.time,e.ctime.find(".h").html(t),e.ctime.find(".m").html(n),e.ctime.find(".s").html(r),e},this.set=function(e,t){var n=this;t=Number(t);switch(e){case"h":n.time.setHours(t);break;case"m":n.time.setMinutes(t);break;case"s":n.time.setSeconds(t)}n._render()},this.get=function(e){var t=this,n=t.time;switch(e){case"h":return n.getHours();case"m":return n.getMinutes();case"s":return n.getSeconds()}},this.add=function(){var e=this,t=e.status,n=e.get(t);n++,e.set(t,n)},this.minus=function(){var e=this,t=e.status,n=e.get(t);n--,e.set(t,n)},this._timeInit=function(){var n=this;t.html("").append(n.ctime),t.append(n.button),n._render(),n.popupannel.bind("click",function(t){var r=e(t.target);if(r.hasClass("x"))n.hidePopup();else if(r.hasClass("om-cal-item")){var i=Number(r.html());n.set(n.status,i),n.hidePopup()}}),n.button.bind("click",function(t){var r=n.father.options,i=typeof n.father.dt_date=="undefined"?r.date:n.father.dt_date;i.setHours(n.get("h")),i.setMinutes(n.get("m")),i.setSeconds(n.get("s")),n.father._trigger("onSelect",t,i);if(r.popup){var s=e.omCalendar.formatDate(i,r.dateFormat||n.father._defaultFormat);e(n.father.element).val(s),n.father.hide()}}),n.ctime.bind("keyup",function(t){if(t.keyCode==e.om.keyCode.UP||t.keyCode==e.om.keyCode.LEFT)t.preventDefault(),n.add();if(t.keyCode==e.om.keyCode.DOWN||t.keyCode==e.om.keyCode.RIGHT)t.preventDefault(),n.minus()}),n.ctime.find(".u").bind("click",function(){n.hidePopup(),n.add()}),n.ctime.find(".d").bind("click",function(){n.hidePopup(),n.minus()}),n.ctime.find(".h").bind("click",function(){var e=n.parseSubHtml(n.h_a);n.status="h",n.showPopup(e)}),n.ctime.find(".m").bind("click",function(){var e=n.parseSubHtml(n.m_a);n.status="m",n.showPopup(e)}),n.ctime.find(".s").bind("click",function(){var e=n.parseSubHtml(n.s_a);n.status="s",n.showPopup(e)})},this._timeInit()}}),e.omCalendar=e.omCalendar||{},e.extend(e.omCalendar,{leftPad:function(e,t,n){var r=new String(e);n||(n=" ");while(r.length<t)r=n+r;return r.toString()}}),e.extend(e.omCalendar,{getShortDayName:function(t){return e.omCalendar.dayMaps[t][0]},getDayName:function(t){return e.omCalendar.dayMaps[t][1]},getShortMonthName:function(t){return e.omCalendar.monthMaps[t][0]},getMonthName:function(t){return e.omCalendar.monthMaps[t][1]},dayMaps:[["Sun","Sunday"],["Mon","Monday"],["Tue","Tuesday"],["Wed","Wednesday"],["Thu","Thursday"],["Fri","Friday"],["Sat","Saturday"]],monthMaps:[["Jan","January"],["Feb","February"],["Mar","March"],["Apr","April"],["May","May"],["Jun","June"],["Jul","July"],["Aug","August"],["Sep","September"],["Oct","October"],["Nov","November"],["Dec","December"]],formatCodes:{d:{g:"this.getDate()",s:"this.setDate({param})",r:"(0[1-9]|[1-2][0-9]|3[0-1]|[1-9])"},dd:{g:"$.omCalendar.leftPad(this.getDate(), 2, '0')",s:"this.setDate(parseInt('{param}', 10))",r:"(0[1-9]|[1-2][0-9]|3[0-1]|[1-9])"},m:{g:"(this.getMonth() + 1)",s:"this.setMonth(parseInt('{param}', 10) - 1)",r:"(0[1-9]|1[0-2]|[1-9])"},mm:{g:"$.omCalendar.leftPad(this.getMonth() + 1, 2, '0')",s:"this.setMonth(parseInt('{param}', 10) - 1)",r:"(0[1-9]|1[0-2]|[1-9])"},y:{g:"('' + this.getFullYear()).substring(2, 4)",s:"this.setFullYear(parseInt('20{param}', 10))",r:"(\\d{2})"},yy:{g:"this.getFullYear()",s:"this.setFullYear(parseInt('{param}', 10))",r:"(\\d{4})"},h:{g:"$.omCalendar.leftPad((this.getHours() % 12) ? this.getHours() % 12 : 12, 2, '0')",s:"this.setHours(parseInt('{param}', 10))",r:"(0[0-9]|1[0-1])"},H:{g:"$.omCalendar.leftPad(this.getHours(), 2, '0')",s:"this.setHours(parseInt('{param}', 10))",r:"([0-1][0-9]|2[0-3])"},g:{g:"((this.getHours() % 12) ? this.getHours() % 12 : 12)",s:"this.setHours(parseInt('{param}', 10))",r:"([0-9]|1[0-1])"},G:{g:"this.getHours()",s:"this.setHours(parseInt('{param}', 10))",r:"([0-9]|1[0-9]|2[0-3])"},i:{g:"$.omCalendar.leftPad(this.getMinutes(), 2, '0')",s:"this.setMinutes(parseInt('{param}', 10))",r:"([0-5][0-9])"},s:{g:"$.omCalendar.leftPad(this.getSeconds(), 2, '0')",s:"this.setSeconds(parseInt('{param}', 10))",r:"([0-5][0-9])"},u:{g:"$.omCalendar.leftPad(this.getMilliseconds(), 3, '0')",s:"this.setMilliseconds(parseInt('{param}', 10))",r:"(\\d{1,3})"},D:{g:"$.omCalendar.getShortDayName(this.getDay())",s:"",r:""},DD:{g:"$.omCalendar.getDayName(this.getDay())",s:"",r:""},M:{g:"$.omCalendar.getShortMonthName(this.getMonth())",s:"",r:""},MM:{g:"$.omCalendar.getMonthName(this.getMonth())",s:"",r:""},a:{g:"(this.getHours() < 12 ? 'am' : 'pm')",s:"",r:""},A:{g:"(this.getHours() < 12 ? 'AM' : 'PM')",s:"",r:""}}}),e.extend(e.omCalendar,{formatDate:function(t,n){if(!t||!n)return null;if(Object.prototype.toString.call(t)!=="[object Date]")return null;var r,i,s="",o=!1;for(r=0;r<n.length;r++){i=n.charAt(r),fi_next=n.charAt(r+1);if(i=="'"){o=!o;continue}!o&&e.omCalendar.formatCodes[i+fi_next]?(i=(new Function("return "+e.omCalendar.formatCodes[i+fi_next].g)).call(t),r++):!o&&e.omCalendar.formatCodes[i]&&(i=(new Function("return "+e.omCalendar.formatCodes[i].g)).call(t)),s+=i}return s},parseDate:function(t,n){if(!t||!n)return null;if(Object.prototype.toString.call(t)!=="[object String]")return null;var r=[],i,s,o=null,u;for(i=0;i<n.length;i++){s=n.charAt(i),fi_next=n.charAt(i+1);if(e.omCalendar.formatCodes[s+fi_next])o=e.omCalendar.formatCodes[s+fi_next],i++;else{if(!e.omCalendar.formatCodes[s])continue;o=e.omCalendar.formatCodes[s]}u=t.match(new RegExp(o.r));if(!u)return null;r.push(o.s.replace("{param}",u[0])),t=t.substring(u.index+u[0].length);var a=n.charAt(i+1);if((a!=""||t!="")&&a!==t.charAt(0)&&e.omCalendar.formatCodes[a]===undefined)return null}var f=new Date;return(new Function(r.join(";"))).call(f),f}}),e.om.lang.omCalendar={year:"年",month:"月",Su:"日",Mo:"一",Tu:"二",We:"三",Th:"四",Fr:"五",Sa:"六",cancel:"取消",ok:"确定",time:"时间"}})(jQuery);