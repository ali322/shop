(function(e){function n(t){var n=e(this),r=t.element,i,s,o,a=t._getColModel(),f,l,h=t.options;if(!u(t))return;if(!t._allEditMode&&!n.attr("_insert"))return;if(t._triggered&&t._editView.editing&&g(n)==t._editView.rowId)return;if(t._rowAdding)return;var p=t._getTrs().index(n),d=t._getRowData(p);if(h.onBeforeEdit&&h.onBeforeEdit.call(t,p,d)===!1)return;c(t,n),i=t._editView.editRow,s=i.find(">.grid-edit-form"),o=r.parent().scrollLeft(),t._getHeaderCols().each(function(u){var c=e(this).attr("axis"),h,p=n.find("td:eq("+u+")"),v,m;if(c.substring(0,3)!="col"){e.isEmptyObject(t._editComps)&&i.css("padding-left",parseInt(i.css("padding-left"))+p.outerWidth());return}var g=c.substring(3);h=a[g];var y=h.editor;if(!t._triggered){if(!y||y&&(y.editable===!1||e.isFunction(y.editable)&&y.editable()===!1)){var w=y&&y.renderer;h.editor=y={},y.type="text",w&&(y.renderer=w,y.type="custom"),y.editable=!1}else y.type=y.type||"text",y.editable=!0,y.rules&&(t._validate=!0);m=h.editor.name||h.name,y.options=y.options||{},t._editComps[m]={}}else m=h.editor.name||h.name;f=t._editComps[m],l=(l=b(t,n,h))==undefined?"":l,!t._triggered&&y.editable&&y.rules&&(t._errorHolders[m]=e("<div class='errorContainer' style='display:none'></div>").appendTo(r.parent()));var E=f.instance,S,x=y.type;if(!E){S=e("<div style='position:absolute'></div>").css({left:p.position().left+o,top:3}).appendTo(s).addClass("grid-edit-wrapper"),E=f.instance=e("<input></input>").attr({name:m,id:m}).appendTo(S),"text"!=x&&"custom"!=x&&E[x](y.options);if("omCalendar"==x||"omCombo"==x){var T=E.parent();"omCalendar"==x?(E.val(l).width(p.outerWidth()-24),E.width(p.outerWidth(!0)-(T.outerWidth(!0)-E.width()))):(E.next("input").attr({id:E.prop("id"),name:E.prop("name")}),E.attr({id:"",name:""}),E.next("input").width(p.outerWidth(!0)-(T.outerWidth(!0)-E.next("input").width())))}else"text"==x&&(E.addClass("grid-edit-text"),y.editable||E.attr("readonly","readonly").addClass("readonly-text")),"custom"==x&&(E=f.instance=S.html(y.renderer.call(t,l,d))),E.width(p.outerWidth(!0)-(E.outerWidth(!0)-E.width()));f.model=h,f.type=x,f.id=h.name;if("custom"!=x){var N="omCombo"==x?E.next():E;N.blur(function(e){var n=t._errorHolders[m];n&&n.hide()})}}switch(x){case"omCalendar":E=E.val(l).omCalendar();break;case"omNumberField":E.val(l).trigger("blur");break;case"omCombo":E.omCombo("value",l);break;case"text":E.val(l);break;case"custom":E.html(y.renderer.call(t,l,d));default:}}),!t._triggered&&t._validate&&E(t),t._validator&&t._validator.form(),t._triggered=!0}function r(e){e._changeData={update:{},insert:{},"delete":{}}}function i(e){return!u(e)||!l(e)}function s(e){var t=e.element,n=t.parent(),r=e._editView,i=r.view,s=r.editBtn,o=r.editRow,u={};return u.top=o.height(),t.width()<n.width()?u.left=t.width()/2-s.width()/2:u.left=n.scrollLeft()+n.width()/2-s.width()/2,u}function o(){u(this)&&(r(this),a(this),this._triggered&&(f(this),this._editView.view.hide(),this._editView.editing=!1,this.hDiv.scrollLeft(0),this.element.parent().scrollLeft(0)))}function u(e){return!e._allEditMode||e._globalEditable}function a(e){var t=e.getData().rows;e._rowIdDataMap={},e._getTrs().each(function(n,r){e._rowIdDataMap[g(r)]=t[n]})}function f(t){t._validator&&(t._validator.resetForm(),e.each(t._errorHolders,function(e,t){t.empty().hide()}))}function l(t){var n=t._changeData;return!(e.isEmptyObject(n.update)&&e.isEmptyObject(n.insert)&&e.isEmptyObject(n["delete"]))}function c(t,n){var r=t.element,i=r.next(".grid-edit-view"),o,u,a=e(n).position(),f=r.parent().scrollTop(),l=t.options;if(i.length==0){i=e("<div class='grid-edit-view'><div class='body-wrapper'><div class='grid-edit-row'><form class='grid-edit-form'></form></div><div class='gird-edit-btn'><input type='button' class='ok' value='确定'/><input type='button' class='cancel' value='取消'/></div></div></div>").width(r.outerWidth()).insertAfter(r);var o=i.find(".gird-edit-btn"),u=o.prev(".grid-edit-row"),c;t._editView={view:i,editRow:u,editBtn:o},c=s(t),o.css({left:c.left,top:c.top});var h=o.find("input.ok").omButton(),d=o.find("input.cancel").omButton();h.click(function(){if(t._validator&&!t._validator.form())return;var e=r.find("tr[_grid_row_id='"+t._editView.rowId+"']");v(t,e),i.hide(),t._editView.editing=!1,h.blur(),t._rowAdding&&(t._refreshHeaderCheckBox(),t._rowAdding=!1);var n=t._getTrs().index(e);l.onAfterEdit&&l.onAfterEdit.call(t,n,t._getRowData(n))}),d.click(function(){t.cancelEdit(this)})}t._editView.rowId=g(n),t._editView.editing?i.animate({top:a.top+f},"fast"):(i.css({top:a.top+f}),t._editView.editing=!0,i.show(),t._colWidthResize&&(p(t),t._colWidthResize=!1))}function h(){if(!u(this)||!this._triggered)return;if(this._editView.editing){this.element.parent().scrollLeft(0);var e=this;setTimeout(function(){p(e)},0)}else this._colWidthResize=!0}function p(t,n,r){var i=t.element,o=t._editView,u=o.view,a=i.parent().scrollLeft(),f=o.editBtn,l;u.width(i.outerWidth()),t._getHeaderCols().each(function(i,s){var o=e(s).attr("abbr"),u=e(s),f=n&&n.prop("abbr")===u.prop("abbr");f&&(l=!0);if(n&&!l)return;e.each(t._editComps,function(e,t){var i=t.instance,s=t.type;if(o==t.id){if(!f&&n)return i.closest("div.grid-edit-wrapper").css("left","+="+r),!1;f||i.closest("div.grid-edit-wrapper").width(u.outerWidth()).css("left",u.position().left+a);if("omCalendar"==s||"omCombo"==s){var l=i.parent();"omCalendar"==s?(i.width(u.outerWidth()-24),i.width(u.outerWidth(!0)-(l.outerWidth(!0)-i.width()))):i.next("input").width(u.outerWidth(!0)-(l.outerWidth(!0)-i.next("input").width()))}else i.width(u.outerWidth(!0)-(i.outerWidth(!0)-i.width()))}})});var c=s(t);n?f.animate({left:c.left,top:c.top},"fast"):f.css({left:c.left,top:c.top})}function d(e,t){if(!u(this)||!this._triggered||!this._editView.editing){this._colWidthResize=!0;return}p(this,e,t)}function v(t,n){var r=e(n),i=t._editView.editRow,s=t._editComps,o=g(r),u=t._getTrs().index(r),a=t._getRowData(u);e.each(s,function(i,s){var f=s.model.name,l=y(t,r,s),c,h,p;r.attr("_insert")?t._changeData.insert[o][f]=l:(c=w(t,n)[f],p=t._changeData.update[o],String(l)===String(c)?(m(r,s.model,!1),p&&delete p[f],e.isEmptyObject(p)&&delete t._changeData.update[o]):(m(r,s.model,!0),p=t._changeData.update[o]=p||{},p[f]=l)),s.model.renderer?h=s.model.renderer(l,a,u):h=l==undefined?"":l,r.find("td[abbr='"+f+"'] >div").html(h)})}function m(e,t,n){e.find("td[abbr='"+t.name+"']").toggleClass("grid-cell-dirty",n)}function g(t){return e(t).attr("_grid_row_id")}function y(e,t,n){var r,i=w(e,t),s=n.instance;switch(n.type){case"omCalendar":r=s.val();case"omNumberField":r=s.val();break;case"omCombo":r=s.omCombo("value");break;case"text":r=s.val();break;case"custom":if(n.model.editor.getValue)return n.model.editor.getValue.call(s,i,n.model.name);default:}return r}function b(e,t,n){var r,i=n.name;if(t.attr("_insert"))r=w(e,t)[i];else{var s=e._changeData.update[g(t)];s&&s[i]!=null?r=s[i]:r=w(e,t)[i]}return r}function w(t,n){var r=g(n);return e(n).attr("_insert")?t._changeData.insert[r]:t._rowIdDataMap[r]}function E(t){var n=t._editView.editRow.find(">.grid-edit-form"),r={},i=r.rules={},s=r.messages={},o=t._getColModel();e.each(o,function(t,n){var r=n.editor.rules;if(r){var o=i[n.editor.name||n.name]={},u=s[n.editor.name||n.name]={};if(r.length>0&&!e.isArray(r[0])){var a=[];a.push(r),r=a}for(var f=0,l=r.length;f<l;f++){var c=r[f][0];o[c]=r[f][1]==undefined?!0:r[f][1],r[f][2]&&(u[c]=r[f][2])}}}),e.extend(r,{onkeyup:function(e){this.element(e)},errorPlacement:function(e,t){},showErrors:function(n,r){r&&r.length>0?e.each(r,function(n,r){var i=e(r.element),s=i.attr("name"),o=t._errorHolders[s];if(o){var u=i.offset(),a=t.element.offset();o.css({left:u.left-a.left+i.outerWidth(),top:u.top-a.top+i.outerHeight()}).html(r.message),i.is(":focus")&&o.show()}}):e.each(this.currentElements,function(n,r){var i=t._errorHolders[e(r).attr("name")];i&&i.empty().hide()});var i=t._editView.editBtn.find("input.ok"),s=!0;e.each(t._errorHolders,function(e,t){if(!t.is(":empty"))return s=!1}),s?i.omButton("enable"):i.omButton("disable"),this.defaultShowErrors()}}),t._validator=n.validate(r),e.each(t._editComps,function(e,n){var r=n.model.editor;if(r.editable&&r.rules){var i=r.name||n.model.name,s=t._errorHolders[i],o=n.type=="omCombo"?n.instance.next("input"):n.instance;o.mouseover(function(){s&&!s.is(":empty")&&s.show()}).mouseout(function(){s&&s.hide()})}})}var t=Object.prototype.hasOwnProperty;e.omWidget.addInitListener("om.omGrid",function(){var a=this,c=a.element,p=a.options,v=this._getColModel();a._triggered=!1,a._globalEditable=!1,p.editMode=p.editMode||"all",a._allEditMode=p.editMode=="all";for(var m=0,y=v.length;m<y;m++){a._globalEditable=v[m].editor?!0:!1;if(a._globalEditable)break}if(!u(a))return;a._editComps={},a._errorHolders={},a._colWidthResize,p._onRefreshCallbacks.push(o),p._onResizableCallbacks.push(d),p._onResizeCallbacks.push(h),this.tbody.delegate("tr.om-grid-row","dblclick",function(e){n.call(this,a)}),this.tbody.delegate("tr.om-grid-row","click",function(e){a._triggered&&a._editView.editing&&(a._validator?a._validator.valid()&&n.call(this,a):n.call(this,a))});var b;c.parent().scroll(function(){a._triggered&&(b&&clearTimeout(b),b=setTimeout(function(){var e=s(a);a._editView.editBtn.animate({left:e.left,top:e.top},a._editView.editing?"fast":0),b=null},300))}),e.extend(this,{cancelEdit:function(t){var n=this._editView,r=this.options;if(!u(this)||!this._triggered||this._triggered&&!n.editing)return;n.view.hide(),n.editing=!1,this._rowAdding&&(this.deleteRow(this._getTrs().index(this.tbody.find("tr[_grid_row_id='"+a._editView.rowId+"']"))),this._rowAdding=!1),f(this),t&&e(t).blur(),r.onCancelEdit&&r.onCancelEdit.call(this)},cancelChanges:function(){this.cancelEdit();if(i(this))return;r(this),f(this),this.refresh()},editRow:function(e){if(!u(this))return;n.call(this._getTrs().eq(e)[0],this)},deleteRow:function(t){if(!u(this)||this._triggered&&this._editView.editing)return;var n=this._getTrs(),r=this;e.isArray(t)||(t=[t]),t.sort(function(e,t){return t-e}),e(t).each(function(e,t){var i=n.eq(t),s=i.next(),o=g(i);i.attr("_insert")?(delete r._changeData.insert[o],i.remove(),s.hasClass("rowExpand-rowDetails")&&s.remove()):(r._changeData["delete"][o]=r._rowIdDataMap[o],i.attr("_delete","true").hide(),s.hasClass("rowExpand-rowDetails")&&s.hide())}),this._refreshHeaderCheckBox()},getChanges:function(n){var r={update:[],insert:[],"delete":[]},i=n?n:"update",s=this._changeData,o;if(i==="update"){var u=s[i];for(o in u)t.call(u,o)&&r[i].push(e.extend(!0,{},this._rowIdDataMap[o],u[o]));i=n?n:"insert"}if(i==="insert"){var a=s[i];for(o in a)t.call(a,o)&&r[i].push(a[o]);i=n?n:"delete"}if(i==="delete"){var f=s[i];for(o in f)t.call(f,o)&&r[i].push(f[o])}return n?r[n]:r},insertRow:function(t,n,r){var i=this.options,s=this._getColModel(),o=this.element;if(!u(this)||this._rowAdding)return;e.isPlainObject(t)&&(n=t,t=0),t===!0&&(n={},t=0,r=!0);var a=this._getTrs(),f={};t="begin"==t||t==undefined?0:"end"==t?a.length:t;for(var l=0,c=s.length;l<c;l++)f[s[l].name]="";this._changeData.insert[this._guid]=e.extend(!0,f,n);var h=this._buildRowCellValues(s,f,t),p=[],d=i.rowClasses;isRowClassesFn=typeof d=="function",rowCls=isRowClassesFn?d(t,f):d[t%d.length],tdTmp="<td align='$' abbr='$' class='grid-cell-dirty $'><div align='$' class='$' style='width:$px'>$</div></td>",p.push("<tr class='om-grid-row "+rowCls+"' _grid_row_id="+this._guid++ +" _insert='true'>"),this._getHeaderCols().each(function(t){var n=e(this).attr("axis"),r=!1,i,o,u;if(n=="indexCol")i="<a class='om-icon'>新行</a>";else if(n=="checkboxCol")i='<span class="checkbox"/>';else if(n.substring(0,3)=="col"){var a=n.substring(3);i=h[a],s[a].wrap&&(r=!0)}else i="";o=[this.align,this.abbr,n,this.align,r?"wrap":"",e("div",e(this)).width(),i],u=0,p.push(tdTmp.replace(/\$/g,function(){return o[u++]}))}),p.push("</tr>");var v=e(p.join(" ")),m,g;t==0?v.prependTo(o.find(">tbody")):(m=a.eq(t-1),g=m.next(),m=g.hasClass("rowExpand-rowDetails")?g:m,m.after(v)),r||(this.editRow(t),this._rowAdding=!0)},saveChanges:function(){this.cancelEdit();if(i(this))return;var n=this._changeData.update,s=this.element.find("tr.om-grid-row"),o=[];for(var u in n)t.call(n,u)&&e.extend(!0,this._rowIdDataMap[u],n[u]);var a=this;s.each(function(t,n){var r=e(n);r.attr("_delete")?r.remove():o.push(w(a,n))}),this.pageData.data.rows=o,r(this),f(this),this.refresh()},onBeforeEdit:function(e,t){},onAfterEdit:function(e,t){},onCancelEdit:function(){},getData:function(){var e=this.pageData.data,t=this._getTrs(),n=this;return u(this)&&l(this)&&(e={total:e.total},e.rows=[],t.each(function(t,r){e.rows.push(n._getRowData(t))})),e},_getRowData:function(t){var n=this._getTrs().eq(t),r=g(n),s;if(i(this))return this.pageData.data.rows[t];if(n.attr("_insert"))s=this._changeData.insert[r];else{var o=this._rowIdDataMap[r],u=this._changeData.update;s=o,u[r]&&(s=e.extend(!0,{},o,u[r]))}return s}})})})(jQuery);