(function(e){e.omWidget("om.omMenu",{options:{contextMenu:!1,maxWidth:200,minWidth:100,dataSource:"local"},show:function(t){var n=this,r=n.options,i,s,o=n.element,u=e(t).offset();if(r.contextMenu)i=t.pageY,s=t.pageX,t.preventDefault(),t.stopPropagation(),t.cancelBubble=!0;else{var a=parseInt(e(t).css("borderBottomWidth").replace("px",""));i=u.top+e(t).height()+(a!="NaN"?a:0)+1,s=u.left+1}var f=o.parent();while(f.css("position")=="static"&&f[0].nodeName!="BODY")f=f.parent();i-=f.offset().top,s-=f.offset().left,s+o.outerWidth()>document.documentElement.clientWidth&&(s=s-o.outerWidth()-20),e(o).css({top:i+1,left:s,"z-index":1e3}).show(),e(o).children("ul.om-menu").show();var l=e(o).width()*.7;e(o).children("ul.om-menu").children().each(function(t,n){e(n).find("span:first").hasClass("om-menu-item-sep")?e(n).find("span:first").width("98%"):e(n).find("span:first").width()>l&&e(n).find("span:first").width(e(n).attr("aria-haspopup")?l-15:l)})},hide:function(){this._hide()},disableItem:function(e){this.element.find("#"+e).addClass("om-state-disabled").unbind(".menuItem")},enableItem:function(e){var t=this,n=t.element,r=n.find("#"+e);r.removeClass("om-state-disabled"),t._bindLiEvent(r)},destroy:function(){var t=e(document),n;while(n=this.globalEvent.pop())t.unbind(".omMenu",n)},_create:function(){var e=this,t=e.options,n=e.element,r=t.dataSource;n.addClass("om-menu-container om-menu-content om-corner-all"),n.css("position","absolute");if(r)if(r!="local")typeof r=="string"?e._ajaxLoad(n,r):typeof r=="object"&&(n.append(e._appendNodes.apply(e,[r])),e._bindEvent());else{var i=n.children("ul").addClass("om-menu");e._parseDomMenu(i),e._bindEvent()}},_init:function(){var t=this.options,n=this.element;n.css({minWidth:t.minWidth-10,maxWidth:t.maxWidth-10}),e.browser.msie&&e.browser.version=="6.0"&&n.css("width",t.minWidth+30),e.browser.msie&&e.browser.version=="7.0"&&n.css("width",t.maxWidth-10)},_ajaxLoad:function(t,n){var r=this;e.ajax({url:n,method:"POST",dataType:"json",success:function(e){t.append(r._appendNodes.apply(r,[e])),r._bindEvent()}})},_appendNodes:function(t,n){var r=this,i=[],s=n==undefined?"om-menu":"om-menu-content",o=n==undefined?"block":"none",u=n==undefined?"om-menu-icon":"om-menu-icon om-menu-icon-child";i.push('<ul class="'+s+' om-corner-all" style="display:'+o+';">');var a=[];return e(t).each(function(t,n){n.children!=null?(n.disabled===!0||n.disabled=="true"?a.push('<li id="'+n.id+'" aria-haspopup="true"  class="om-state-disabled">'):a.push('<li id="'+n.id+'"  aria-haspopup="true">'),a.push('<a href="javascript:void(0)" class="om-corner-all om-menu-indicator">'),n.icon?a.push('<span class="'+u+n.icon+'"></span>'):null,n.icon?a.push("<span>"+n.label+"</span>"):a.push('<span style="margin-left:2em;">'+n.label+"</span>"),a.push('<span class="ui-icon-span" role="popup"></span>'),a.push("</a>"),a.push(r._appendNodes(n.children,t++)),a.push("</li>")):(n.disabled===!0||n.disabled=="true"?a.push('<li id="'+n.id+'"  class="om-state-disabled">'):a.push('<li id="'+n.id+'" >'),a.push('<a href="javascript:void(0)" class="om-corner-all om-menu-indicator">'),n.icon?a.push('<span class="'+u+n.icon+'"></span>'):null,n.icon?a.push("<span>"+n.label+"</span>"):a.push('<span style="margin-left:2em;">'+n.label+"</span>"),a.push("</a>"),a.push("</li>")),(n.seperator=="true"||n.seperator==1)&&a.push('<li class="om-menu-sep-li"  ><span class="om-menu-item-sep">&nbsp;</span></li>');var i=e(r.element).attr("id")+"_"+n.id;e(r.element).data(i,n)}),i.push(a.join("")),i.push("</ul>"),i.join("")},_parseDomMenu:function(t){t.parent().attr("aria-haspopup")=="true"&&t.addClass("om-menu-content om-corner-all"),t.css("display","none");var n=t.children();for(var r=0;r<n.length;r++){var i=e(n[r]),s=i.children("ul");s.length>0&&(i.attr("aria-haspopup","true"),i.find("span[role='popup']").addClass("ui-icon-span"),this._parseDomMenu(s)),i.find("a").addClass("om-corner-all om-menu-indicator"),i.find("img").addClass("om-menu-icon")}},_showChildren:function(t){var n=this;if(t&&t.length>0){var r=t.children("ul").eq(0);r.css({minWidth:this.options.minWidth,top:t.position().top});var i=t.width();2*i+t.offset().left>document.documentElement.clientWidth&&(i=-i),r.css("left",i),r.show(),r.children().each(function(t,i){e(i).find("span:first").hasClass("om-menu-item-sep")?e(i).find("span:first").width("98%"):(r.width()>n.options.maxWidth?(r.width(n.options.maxWidth),width=n.options.maxWidth*.6):(r.attr("hasShow")==undefined&&(r.width(r.find("li:eq(0)>a:eq(0)").width()+15),r.attr("hasShow",!0)),width=r.width()*.6),e(i).find("span:first").width(width))})}},_hideChildren:function(e){e.children("ul").eq(0).hide()},_bindLiEvent:function(t){var n=this,r=n.element,i=n.options;e(t).bind("mouseenter.menuItem",function(){var t=e(this),r=t.parent().width();t.addClass("om-menu-item-hover"),e.browser.msie&&e.browser.version=="9.0"&&t.parent().width(r),t.attr("aria-haspopup")&&setTimeout(function(){n._showChildren(t)},200)}).bind("mouseleave.menuItem",function(){var t=e(this);t.removeClass("om-menu-item-hover"),setTimeout(function(){t.children("ul").hide()},200)}).bind("mousedown.menuItem",function(t){var s=e(r).data(e(r).attr("id")+"_"+this.id);i.onSelect&&n._trigger("onSelect",t,s)})},_bindEvent:function(){var t=this,n=t.element,r=n.find("ul"),i=n.find("li"),s=e(document),o;for(var u=0;u<i.length;u++)e(i[u]).hasClass("om-state-disabled")||t._bindLiEvent(i[u]);for(var a=0;a<r.length;a++)e(r[a]).bind("mouseleave.menuContainer",function(){var t=e(this);t.parent().attr("aria-haspopup")=="true"&&t.hide()});this.globalEvent=[],s.bind("mousedown.omMenu",o=function(){t._hide()}),this.globalEvent.push(o),s.bind("keyup.omMenu",o=function(r){var i=r.keyCode,s=e.om.keyCode;switch(i){case s.DOWN:t._selectNext();break;case s.UP:t._selectPrev();break;case s.LEFT:t._hideRight();break;case s.RIGHT:t._showRight();break;case s.ENTER:n.css("display")=="block"&&t._backfill(n),t._hide();break;case s.ESCAPE:t._hide();break;default:null}}),this.globalEvent.push(o),s.bind("keydown.omMenu",o=function(e){e.keyCode>=37&&e.keyCode<=40&&e.preventDefault()}),this.globalEvent.push(o)},_hide:function(){var t=this,n=t.element;n.find("ul").css("display","none"),n.find("li.om-menu-item-hover").each(function(t,n){e(n).removeClass("om-menu-item-hover")}),n.hide()},_findNext:function(e){var t,n=e;while((t=e.next("li")).length!==0){if(!t.hasClass("om-menu-sep-li")&&!t.hasClass("om-state-disabled"))return t;e=t}var r=n.parent().find("li:first");while(r.length!==0&&r!=n){if(!r.hasClass("om-menu-sep-li")&&!r.hasClass("om-state-disabled"))return r;r=r.next("li")}},_findPrev:function(e){var t,n=e;while((t=e.prev("li")).length!==0){if(!t.hasClass("om-menu-sep-li")&&!t.hasClass("om-state-disabled"))return t;e=t}var r=n.parent().children(),i=r.eq(r.length-1);while(i.length!==0&&i!=n){if(!i.hasClass("om-menu-sep-li")&&!i.hasClass("om-state-disabled"))return i;i=i.prev("li")}},_selectNext:function(){var e=this,t=e.element,n,r=t.find("li.om-menu-item-hover"),i=r.eq(r.length-1);if(r.length==0){n=t.find("li").eq(0);while(n.hasClass("om-state-disabled"))n=n.next("li");n.addClass("om-menu-item-hover")}else{n=e._findNext(i);if(n.length<=0)return;n.addClass("om-menu-item-hover"),i.removeClass("om-menu-item-hover")}this._hideChildren(i),this._showChildren(n)},_selectPrev:function(){var e=this,t=e.element,n,r=t.find("li.om-menu-item-hover"),i=r.eq(r.length-1);n=t.find("ul.om-menu > li");if(r.length==0){var s=n.eq(n.length-1),o=1;while(s.hasClass("om-state-disabled"))s=n.eq(n.length-o++);(n=s).addClass("om-menu-item-hover")}else{n=e._findPrev(i);if(n.length<=0)return;n.addClass("om-menu-item-hover"),i.removeClass("om-menu-item-hover")}this._hideChildren(i),this._showChildren(n)},_hideRight:function(){var e=this,t=e.element,n=t.find("li.om-menu-item-hover"),r=n.eq(n.length-1);r.removeClass("om-menu-item-hover"),e._hideChildren(r)},_showRight:function(){var e=this,t=e.element,n,r=t.find("li.om-menu-item-hover"),i=r.eq(r.length-1);i.attr("aria-haspopup")=="true"&&(n=i.children("ul").find("li").eq(0),n.addClass("om-menu-item-hover")),e._showChildren(n)},_backfill:function(e){var t=e.find("li.om-menu-item-hover");t.eq(t.length-1).mousedown()}})})(jQuery);