(function(e){var t={open:"open",closed:"closed",expandable:"expandable",expandableHitarea:"expandable-hitarea",lastExpandableHitarea:"lastExpandable-hitarea",collapsable:"collapsable",collapsableHitarea:"collapsable-hitarea",lastCollapsableHitarea:"lastCollapsable-hitarea",lastCollapsable:"lastCollapsable",lastExpandable:"lastExpandable",last:"last",hitarea:"hitarea"};e.omWidget("om.omTree",{_swapClass:function(e,t,n){var r=e.filter("."+t);e.filter("."+n).removeClass(n).addClass(t),r.removeClass(t).addClass(n)},_getParentNode:function(t){if(t){var n=e(t).parent().parent();if(n&&n.hasClass("om-tree-node"))return n}return null},_setParentCheckbox:function(e){var t=this._getParentNode(e);if(t){var n=t.find(">ul >li >div.tree-checkbox"),r=n.length,i=n.filter(".checkbox_full").length,s=n.filter(".checkbox_part").length,o=t.find(">div.tree-checkbox");o.removeClass("checkbox_full checkbox_part"),i==r?o.addClass("checkbox_full"):(i>0||s>0)&&o.addClass("checkbox_part"),this._setParentCheckbox(t)}},_setChildCheckbox:function(e,t){var n=e.find(">ul").find(".tree-checkbox");n.removeClass("checkbox_part checkbox_full"),t&&n.addClass("checkbox_full")},_applyEvents:function(t){var n=this,r=n.options,i=r.onClick,s=r.onDblClick,o=r.onRightClick,u=r.onDrag,a=r.onSelect,f=r.onDrop;t.find("span").bind("click",function(t){var r=n.element.data("nodes")[e(this).parent().attr("id")];return i&&n._trigger("onClick",t,r),n.select(r),!1}).bind("dblclick",function(t){var r=e(this).parent(),i=n.element.data("nodes")[r.attr("id")];r.hasClass("hasChildren")&&r.find("span.folder").removeClass("folder").addClass("placeholder"),r.has("ul").length>0&&e(t.target,this)&&n.toggler(r),r.find("span.placeholder").removeClass("placeholder").addClass("folder"),s&&n._trigger("onDblClick",t,i)}).bind("contextmenu",function(t){var r=n.element.data("nodes")[e(this).parent().attr("id")];o&&n._trigger("onRightClick",t,r)}).bind("mouseover mouseout",function(t){return t.type=="mouseover"?e(this).addClass("hover"):t.type=="mouseout"&&e(this).removeClass("hover"),!1}),n._bindHitEvent(t),t.find("div.tree-checkbox").click(function(t){var r=e(this).parent(),i=n.findByNId(r.attr("id"));n._toggleCheck(r,n.isCheck(i))}),n.options.draggable&&(t.omDraggable({revert:"invalid",onStart:function(e,t){var r=n.findByNId(e.helper.attr("id"));u&&n._trigger("onDrag",t,r)}}),t.omDroppable({greedy:!0,accept:"li.om-tree-node",onDragOver:function(n,r){var i=t.filter(".treenode-droppable");i.length>0?i.removeClass("treenode-droppable"):e(this).addClass("treenode-droppable")},onDragOut:function(t,n){e(this).removeClass("treenode-droppable")},onDrop:function(t,r){var i,s,o=t,u=this,a=u.find(">ul");e(this).removeClass("treenode-droppable"),o.css("left",""),o.css("top","");var l=n.findByNId(u.attr("id")),c=n.findByNId(o.attr("id"));u.has("ul").length>0?i=l:(s=l,c.pid=l.pid);var h=n.findByNId(o.parent().find("li").attr("id"));n.remove(c),n.insert(c,i,s,!0),f&&n._trigger("onDrop",r,h)}})),t.bind("mousedown",function(e){e.stopPropagation()})},_bindHitEvent:function(t){var n=this;t.find("div.hitarea").click(function(){var t=e(this).parent();t.hasClass("hasChildren")&&t.find("span.folder").removeClass("folder").addClass("placeholder"),n.toggler(t),t.find("span.placeholder").removeClass("placeholder").addClass("folder")})},options:{initExpandLevel:0,lineHover:!1,showIcon:!0,showLine:!0,showCheckbox:!1,cascadeCheck:!0,draggable:!1,filter:null,nodeCount:0,simpleDataModel:!1},_create:function(){this.element.data("nodes",[]).data("selected","").data("init_dataSource",[]).addClass("om-tree om-widget")},updateNode:function(e){var t=this,n=t.options,r=e.find("li");t._applyEvents(r),n.control&&t._treeController(t,n.control)},toggler:function(n){var r=this,i=r.options,s=n.attr("id"),o=r.findByNId(s),u=n.hasClass(t.expandable);if(u){var a=i.onBeforeExpand;if(a&&!1===r._trigger("onBeforeExpand",null,o))return r}else{var f=i.onBeforeCollapse;if(f&&!1===r._trigger("onBeforeCollapse",null,o))return r}var l=n.find(n.find(">.hitarea"));r._swapClass(l,t.collapsableHitarea,t.expandableHitarea),r._swapClass(l,t.lastCollapsableHitarea,t.lastExpandableHitarea),r._swapClass(n,t.collapsable,t.expandable),r._swapClass(n,t.lastCollapsable,t.lastExpandable),n.find(">ul").each(function(){if(u){e(this).show();var t=i.onExpand;t&&r._trigger("onExpand",null,o)}else{e(this).hide();var n=i.onCollapse;n&&r._trigger("onCollapse",null,o)}})},_init:function(){var e=this,t=e.options,n=e.element,r=t.dataSource;n.empty(),r&&(typeof r=="string"?e._ajaxLoad(n,r):typeof r=="object"&&(t.simpleDataModel&&(r=e._transformToNodes(r)),n.data("init_dataSource",r),e._appendNodes.apply(e,[n,r]),e.updateNode(n),t.onSuccess&&e._trigger("onSuccess",null,r)))},_ajaxLoad:function(t,n){var r=this,i=this.options,s=i.onBeforeLoad,o=i.onSuccess,u=i.onError;s&&r._trigger("onBeforeLoad",null,r.findByNId(t.parent().attr("id"))),e.ajax({url:n,method:"POST",dataType:"json",cache:!1,success:function(e){i.simpleDataModel&&(e=r._transformToNodes(e)),t.data("init_dataSource",e),r._appendNodes.apply(r,[t,e]),r.updateNode(t),o&&r._trigger("onSuccess",null,e)},error:function(e,t,n){u&&r._trigger("onError",null,e,t,n)}})},check:function(t){this._toggleCheck(e("#"+t.nid),!1)},uncheck:function(t){this._toggleCheck(e("#"+t.nid),!0)},_toggleCheck:function(e,t){var n=e.find(">div.tree-checkbox"),r=this,i=r.options,s=i.onCheck;t?n.removeClass("checkbox_part checkbox_full"):n.removeClass("checkbox_part").addClass("checkbox_full"),r.options.cascadeCheck&&(r._setChildCheckbox(e,!t),r._setParentCheckbox(e)),s&&r._trigger("onCheck",null,r.findByNId(e.attr("id")))},checkAll:function(e){e?this.element.find(".tree-checkbox").removeClass("checkbox_part").addClass("checkbox_full"):this.element.find(".tree-checkbox").removeClass("checkbox_part checkbox_full")},isCheck:function(t){return e("#"+t.nid).find(">div.tree-checkbox").hasClass("checkbox_full")},getChecked:function(t){var n=this,r=[],i=t?".checkbox_full":":not(.checkbox_full)";return this.element.find(".tree-checkbox").filter(i).each(function(t,i){r.push(n.element.data("nodes")[e(this).parent().attr("id")])}),r},select:function(t){var n=this,r=this.options,i=r.onBeforeSelect,s=r.onSelect;if(i&&!1===n._trigger("onBeforeSelect",null,t))return n;var o=e("#"+t.nid);e(" >span",o).addClass("selected");var u=n.element.data("selected"),a=o.attr("id");u!=""&&u!=a&&e("#"+u+" >span").removeClass("selected"),n.element.data("selected",a),s&&n._trigger("onSelect",null,t)},unselect:function(t){var n=this,r=e("#"+t.nid);e(" >span",r).removeClass("selected");var i=n.element.data("selected"),s=r.attr("id");i==s&&n.element.data("selected","")},getSelected:function(){var e=this.element.data("selected");return e?this.element.data("nodes")[e]:null},findNodes:function(e,t,n,r){var i=[],s,o=n?n.children:this.element.data("init_dataSource");r=r!=0?!0:r;if(o&&(s=o.length)>0)for(var u=0;u<s;u++)i=this._searchNode.apply(o[u],[e,t,this._searchNode,i,!1,r]);return i.length>0?i:null},findNode:function(e,t,n,r){var i,s,o=n?n.children:this.element.data("init_dataSource");r=r!=0?!0:r;if(o&&(s=o.length)>0)for(var u=0;u<s;u++){i=this._searchNode.apply(o[u],[e,t,this._searchNode,[],!0,r]);if(i!=null)return i}return null},findByNId:function(e){return this.element.data("nodes")[e]||null},findNodesBy:function(e,t,n){var r,i=t?t.children:this.element.data("init_dataSource");n=n!=0?!0:n;var s=[];if(i&&(len=i.length)>0)for(var o=0;o<len;o++)e.call(i[o],i[o])===!0&&s.push(i[o]),n&&i[o].children&&(r=this.findNodesBy(e,i[o],n),r&&(s=s.concat(r)));return s.length>0?s:null},findNodeBy:function(e,t,n){var r,i=t?t.children:this.element.data("init_dataSource");n=n!=0?!0:n;if(i&&(o=i.length)>0)for(var s=0,o=i.length;s<o;s++){if(e.call(i[s],i[s])===!0)return i[s];if(n){r=this.findNodeBy(e,i[s],n);if(r!=null)return r}}return null},_searchNode:function(t,n,r,i,s,o){if(!s)return this[t]==n&&i.push(this),this.children&&this.children.length&&o&&e.each(this.children,r,[t,n,r,i,!1,o]),i;if(this[t]==n)return this;if(this.children&&this.children.length&&o)for(var u in this.children){var a=r.apply(this.children[u],[t,n,r,[],!0,o]);if(a)return a}},getParent:function(e){var t=this.element.data("nodes")["pid"+e.nid];return t?this.findByNId(t):null},getChildren:function(e){return e.children},getData:function(){return this.options.dataSource},setData:function(e){this.options.dataSource=e},expand:function(n){if(n.nid){var r=t.expandable,i=e("#"+n.nid),s=e(">div."+t.hitarea,i).filter(function(){return r?e(this).parent("."+r).length:!0}).parent().parentsUntil(this.element).andSelf().filter(function(){return e(this).filter("li").hasClass(r)});this.toggler(s)}},collapse:function(n){n.nid&&this._collapseHandler(t.collapsable,e("#"+n.nid))},expandAll:function(){this._collapseHandler(t.expandable,this.element,!0)},collapseAll:function(){this._collapseHandler(t.collapsable,this.element,!0)},_collapseHandler:function(n,r,i){var s=(i?"":">")+"div."+t.hitarea;this.toggler(e(s,r).filter(function(){return n?e(this).parent("."+n).length:!0}).parent())},refresh:function(t){var n=this,r=n.element,i=n.getData();if(!t){r.empty();if(typeof i=="string")n._ajaxLoad(r,i);else if(typeof i=="object"){n.setData([]);for(var s=0,o=i.length;s<o;s++)n.insert(i[s])}}else{var u=e("#"+t.nid).next(),a=r.data("nodes")["pid"+t.nid];n.remove(t),n.insert(t,n.findByNId(a),n.findByNId(u.attr("id")))}},_transformToNodes:function(e){var t,n;if(!e)return[];var r=[],i=[];for(t=0,n=e.length;t<n;t++)i[e[t].id]=e[t];for(t=0,n=e.length;t<n;t++)if(i[e[t].pid]){var s=e[t].pid;i[s].children||(i[s].children=[]),i[s].children.push(e[t])}else r.push(e[t]);return r},_appendNodes:function(n,r,i,s){var o=this,u=[],a=o.options.showCheckbox,f=o.element.attr("id")?o.element.attr("id"):"treeId"+parseInt(Math.random()*1e3);o.element.attr("id",f);for(var l=0,c=r.length;l<c;l++){var h=r[l],p=l==r.length-1,d="om-tree-node "+(a?"treenode-checkable ":"")+(h.hasChildren?"hasChildren ":""),v=f+"_"+ ++o.options.nodeCount;h.nid=v;var m=o.element.data("nodes");m[h.nid]=h,typeof n=="string"?(m["pid"+h.nid]=n,p&&(n=null)):m["pid"+h.nid]=n.parent("li").attr("id");var g=[];h.children&&h.children.length>0&&g.push(o._appendNodes(h.nid,h.children).join(""));var y=0;h.children&&(y=h.children.length)>0||h.hasChildren?h.expanded?d=d+"open "+t.collapsable+" "+(p?t.lastCollapsable:""):d=d+t.expandable+" "+(p?t.lastExpandable:""):d+=p?t.last:"",u.push("<li id='",h.nid,"' class='",d,"'>");if(h.hasChildren||y>0){var b="";e.each(d.split(" "),function(){b+=this+"-hitarea "}),u.push("<div class='",t.hitarea+" "+b,"'/>")}a&&u.push("<div class='tree-checkbox'/>");var w=h.classes?h.classes:"";o.options.showIcon&&(h.hasChildren||h.children&&h.children.length>0?w+=" folder ":w+=" file "),u.push("<span class='",w,"'>","<a href='#'>",h.text,"</a></span>");if(h.hasChildren||y>0)u.push("<ul"," style='display:",h.expanded?"block":"none","'>"),u.push(g.join("")),u.push("</ul>");u.push("</li>")}return i?s?e("#"+i.nid).after(u.join("")):e("#"+i.nid).before(u.join("")):n&&n.append(u.join("")),u},remove:function(n,r){var i,s=this,o=r?r.children:s.element.data("init_dataSource");for(var u in o){if(o[u]==n){var a=[];a=s._findChildrenId(n,a),a.push(n.nid);for(var f=0,l=a.length;f<l;f++)delete s.element.data("nodes")[a[f]],delete s.element.data("nodes")["pid"+a[f]];n.nid==s.element.data("selected")&&this.element.data("selected",null);var c=e("#"+n.nid).prev();return e("#"+n.nid).next().length<1&&c.length>0&&(c.hasClass(t.collapsable)?(c.addClass(t.lastCollapsable),c.find("div.hitarea").first().addClass(t.lastCollapsableHitarea)):c.hasClass(t.expandable)?(c.addClass(t.lastExpandable),c.find("div.hitarea").first().addClass(t.lastExpandableHitarea)):c.addClass(t.last)),e("#"+n.nid).remove(),o.splice(u,1),r&&r.nid&&o.length<1&&s._changeToFolderOrFile(r,!1),!0}if(o[u].children){i=s.remove(n,o[u]);if(i)return!0}}return!1},_findChildrenId:function(e,t){if(e.children)for(var n=0,r=e.children,i=r.length;n<i;n++)t.push(r[n].nid),r[n].children&&this._findChildrenId(r[n],t);return t},insert:function(n,r,i,s){if(!n)return;var o=this,u=[],a,f,l=e.isArray(n);l?u=n:u.push(n),i&&(r=r||o.findByNId(o.element.data("nodes")["pid"+i.nid]));var c,h=r?r.children:o.element.data("init_dataSource");r&&(!r.children||r.children.length<1)&&(r.hasChildren||(o._changeToFolderOrFile(r,!0),o._bindHitEvent(e("#"+r.nid))),h=r.children=[]),a=r?e("#"+r.nid).children("ul").first():o.element,f=a.find("li"),i&&(c=e.inArray(i,h))>=0?(o._appendNodes(a,u,i,s),h.splice(c,0,n)):(o._appendNodes(a,u,i,s),l?e.merge(h,n):h.push(n));var p=a.find("li").filter("."+t.last+",."+t.lastCollapsable+",."+t.lastExpandable).not(a.find("li").filter(":last-child:not(ul)"));p.removeClass(t.last+" "+t.lastCollapsable+" "+t.lastExpandable),p.find(" >div").removeClass(t.lastCollapsableHitarea+" "+t.lastExpandableHitarea);var d=a.find("li").not(f);o._applyEvents(d)},_changeToFolderOrFile:function(n,r){var i=e("#"+n.nid),s=this;if(r){var o=e("<ul/>").css("display","block").appendTo(i);i.addClass("open "+t.collapsable),s._swapClass(i,t.last,t.lastCollapsable),n.children=[]}else i.find("ul").remove(),i.find("div."+t.hitarea).remove(),i.filter("."+t.lastCollapsable+",."+t.lastExpandable).removeClass(t.lastCollapsable+" "+t.lastExpandable).addClass(t.last),i.removeClass("open "+t.collapsable+" "+t.expandable);s.options.showIcon&&s._swapClass(i.children("span"),"file","folder");var u=i.filter(":has(>ul)").prepend('<div class="'+t.hitarea+'"/>').find("div."+t.hitarea);u.each(function(){var t="";e.each(e(this).parent().attr("class").split(" "),function(){t+=this+"-hitarea "}),e(this).addClass(t)})},modify:function(t,n,r){if(t&&n){var i=this,s=e("#"+t.nid).next(),o;r=r||this.findByNId(i.element.data("nodes")["pid"+t.nid]);if(s.is("ul")||s.is("li"))o=i.findByNId(s.attr("id"));i.remove(t,r),i.insert(n,r,o)}},disable:function(){},enable:function(){}})})(jQuery);