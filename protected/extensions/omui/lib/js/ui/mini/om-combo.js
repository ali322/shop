(function(e){Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length;for(var n=0;n<t;n++)if(this[n]===e)return n;return-1}),e.omWidget("om.omCombo",{options:{optionField:"text",valueField:"value",width:"auto",disabled:!1,readOnly:!1,editable:!0,lazyLoad:!1,listMaxHeight:300,listAutoWidth:!1,autoFilter:!0,filterStrategy:"first",filterDelay:500,forceSelection:!1,multi:!1,multiSeparator:","},_init:function(){var e=this.options,t=this.textInput,n=e.dataSource;e.inputField||(e.inputField=e.optionField),typeof e.value!="undefined"&&(e.lazyLoad=!1);if(e.width!="auto"){var r=t.parent().width(e.width);t.width(r.innerWidth()-t.next().outerWidth()-t.outerWidth()+t.width())}e.multi&&(e.editable=this.options.editable=!1),this._refeshEmptyText(e.emptyText),e.disabled?t.attr("disabled",!0):t.removeAttr("disabled"),e.readOnly||!e.editable?t.attr("readonly","readOnly"):t.removeAttr("readonly"),e.lazyLoad?this.dataHasLoaded=!1:(this._toggleLoading("add"),n&&typeof n=="string"?this._ajaxLoad(n):n&&typeof n=="object"?(this._loadData(n),this._toggleLoading("remove")):(this.dataHasLoaded=!0,this._toggleLoading("remove")));var i=e.disabled||e.readOnly;i?this.expandTrigger.addClass("om-state-disabled"):this._bindEvent()},_create:function(){var t=this.element,n=e('<span class="om-combo om-widget om-state-default"></span>').css("position","relative").insertAfter(t).wrapInner(t);this.textInput=t.clone().removeAttr("id").removeAttr("name").appendTo(n),this.expandTrigger=e('<span class="om-combo-trigger"></span>').appendTo(n),t.hide(),this.dropList=e(e('<div class="om-widget"><div class="om-widget-content om-droplist"></div></div>').css({position:"absolute",zIndex:2e3}).appendTo(n).children()[0]).hide()},setData:function(e){var t=this,n=t.textInput,r=t.element;t.options.value="",r.val(""),n.val(""),t._toggleLoading("add"),typeof e=="string"?t._ajaxLoad(e):(t._loadData(e),t._toggleLoading("remove"))},getData:function(){var e=this.options.dataSource;return typeof e=="object"?e:null},value:function(e){if(typeof e=="undefined"){var t=this.element.val();return t?t:""}return this._setValue(e+""),this},disable:function(){var e=this.element;e.attr("disabled",!0).unbind(),this.options.disabled=!0,this.expandTrigger.addClass("om-state-disabled").unbind()},enable:function(){var e=this.element;e.removeAttr("disabled").unbind(),this.options.disabled=!1,this.expandTrigger.removeClass("om-state-disabled").unbind(),this._bindEvent()},destroy:function(){var t=this.element;e(document).unbind("mousedown.omCombo",this.globalEvent),t.parent().after(t).remove(),this.dropList.parent().remove()},_bindEvent:function(){var t=this,n=t.options,r=t.textInput,i=t.element,s=t.dropList,o=t.expandTrigger,u=n.emptyText,a=!1,f=r.parent("span");f.mouseenter(function(){n.disabled||f.addClass("om-state-hover")}).mouseleave(function(){f.removeClass("om-state-hover")}).mousedown(function(e){e.stopPropagation()}),r.focus(function(){if(a)return;a=!0,e(".om-droplist").not(s).hide(),f.addClass("om-state-focus"),t._refeshEmptyText(u),t.dataHasLoaded||o.hasClass("om-loading")||(t._toggleLoading("add"),typeof n.dataSource=="object"?(t._loadData(n.dataSource),t._toggleLoading("remove")):typeof n.dataSource=="string"?t._ajaxLoad(n.dataSource):(t.dataHasLoaded=!0,t._toggleLoading("remove"))),!n.disabled&&!n.readOnly&&t._showDropList()}).blur(function(s){a=!1,f.removeClass("om-state-focus"),r.removeClass("om-combo-focus");if(!n.disabled&&!n.readOnly&&!n.multi){if(t.hasManualInput){t.hasManualInput=!1;var o=r.val();if(o!==""){var l=e.data(i,"allInputText"),c=e.data(i,"allValues"),h=l.indexOf(o);if(h>-1)t._setValue(c[h]);else if(!n.forceSelection)i.val(r.val());else{var p=i.val();h=c.indexOf(p),h>-1?r.val(l[h]):r.val("")}}else i.val("")}t._refeshEmptyText(u)}}).keyup(function(i){var o=i.keyCode,u=e.om.keyCode;switch(o){case u.DOWN:t._selectNext();break;case u.UP:t._selectPrev();break;case u.ENTER:t._backfill(t.dropList.find(".om-state-hover"));break;case u.ESCAPE:s.hide();break;case u.TAB:break;default:t.hasManualInput=!0,!n.disabled&&!n.readOnly&&n.editable&&n.autoFilter&&(window._omcomboFilterTimer&&clearTimeout(window._omcomboFilterTimer),window._omcomboFilterTimer=setTimeout(function(){e(document).attr("activeElement").id==r.attr("id")&&s.show(),t._doFilter(r)},n.filterDelay))}}),s.mousedown(function(e){e.stopPropagation()}),o.click(function(){!o.hasClass("om-loading")&&r.focus()}).mousedown(function(){!o.hasClass("om-loading")&&f.addClass("om-state-active")}).mouseup(function(){!o.hasClass("om-loading")&&f.removeClass("om-state-active")}),e(document).bind("mousedown.omCombo",this.globalEvent=function(){s.hide()})},_showDropList:function(){var t=this,n=t.options,r=t.textInput,i=t.element,s=t.dropList.scrollTop(0).css("height","auto"),o,u=i.val(),a=s.find(".om-combo-list-row"),f=t._getAllOptionsBeforeFiltered().removeClass("om-helper-hidden om-state-hover");if(f.size()<=0)return;a.removeClass("om-combo-selected");if(u!==undefined&&u!==""){var l=e.data(i,"allValues");if(n.multi){var c=u.split(n.multiSeparator);for(var h=0;h<c.length;h++){var p=l.indexOf(c[h]);p>-1&&e(s.find(".om-combo-list-row").get(p)).addClass("om-combo-selected")}valueItem=c[0]}else{var p=l?l.indexOf(u):-1;p>-1&&(o=e(s.find(".om-combo-list-row").get(p)).addClass("om-combo-selected"))}}var d=s.parent(),v=r.parent();n.listAutoWidth?e.browser.msie&&e.browser.version=="7.0"&&!e.support.style?d.width(s.outerWidth()):d.width(s.outerWidth()):d.width(v.outerWidth()),n.listMaxHeight!="auto"&&s.height()>n.listMaxHeight&&s.height(n.listMaxHeight).css("overflow-y","auto");var m=v.offset();d.css({left:"-1px",top:v.outerHeight()}),s.toggle(),o&&s.scrollTop(e(o).offset().top-s.offset().top)},_toggleLoading:function(e){this.options.disabled||(e=="add"?this.expandTrigger.removeClass("om-icon-carat-1-s").addClass("om-loading"):e=="remove"&&this.expandTrigger.removeClass("om-loading").addClass("om-icon-carat-1-s"))},_ajaxLoad:function(t){var n=this,r=this.options;e.ajax({url:t,method:"POST",dataType:"json",success:function(e,t){n.dataHasLoaded=!0;var i=r.onSuccess;if(i&&n._trigger("onSuccess",null,e,t)===!1){r.dataSource=e;return}n._loadData(e),n._toggleLoading("remove")},error:function(e,i,s){n.dataHasLoaded=!0;if(!r.onError)throw n._toggleLoading("remove"),new Error('An error occurred while load records from URL "'+t+'",the error message is:'+s.message);n._toggleLoading("remove"),n._trigger("onError",null,e,i,s)}})},_loadData:function(t){var n=this.options,r=this.element;n.dataSource=t,this.dataHasLoaded=!0;var i=n.inputField,s=[];typeof i=="string"?e(t).each(function(){s.push(this[i])}):e(t).each(function(e){s.push(i(this,e))}),e.data(r,"allInputText",s);var o=n.valueField,u=[];typeof o=="string"?e(t).each(function(){u.push(""+this[o])}):e(t).each(function(e){u.push(""+o(this,e))}),e.data(r,"allValues",u);var a=this.dropList.empty();if(n.listProvider){var f=n.listProvider(a,t);f&&f.each(function(){e(this).addClass("om-combo-list-row")})}else{var l=n.optionField,c="",h=this;typeof l=="string"?e(t).each(function(e){c+=h._wrapText(this[n.optionField])}):e(t).each(function(e){c+=h._wrapText(n.optionField(this,e))}),c&&(e(c).appendTo(a),a.css("height","auto"),n.listMaxHeight!="auto"&&a.height()>n.listMaxHeight&&a.height(n.listMaxHeight).css("overflow-y","auto"),a.hide(),r.parent().hasClass("om-state-hover")&&h._showDropList())}n.value&&this._setValue(""+n.value),this._bindEventsToList()},_bindEventsToList:function(){var t=this,n=t._getAllOptionsBeforeFiltered();n.hover(function(){n.removeClass("om-state-hover"),e(this).addClass("om-state-hover")},function(){e(this).removeClass("om-state-hover")}).mousedown(function(){t._backfill(this)})},_wrapText:function(e){return'<div class="om-combo-list-row">'+e+"</div>"},_setValue:function(t){var n=this.textInput,r=this.element,i=!0,s=r.val(),o=this.options;t==s&&(i=!1);var u=e.data(r,"allValues"),a=[],f=[];o.multi?f=t.split(o.multiSeparator):f.push(t);for(var l=0;l<f.length;l++){var c=u?u.indexOf(f[l]):-1;c>-1?a.push(e.data(r,"allInputText")[c]):o.forceSelection?(r.val(""),t=""):a.push(t)}r.val(t),o.multi?n.val(a.join(o.multiSeparator)):n.val(a.join("")),o.value=t,o.onValueChange&&i&&this._trigger("onValueChange",null,n,t,s),this._refeshEmptyText(o.emptyText)},_findHighlightItem:function(){var e=this.dropList,t=e.find(".om-state-hover");if(t.length>0)return t;var n=e.find(".om-combo-selected");return n.length>0?n[0]:n},_selectPrev:function(){var t=this._findHighlightItem(),n=this._getAllOptionsAfterFiltered(),r=n.index(t),i=e(n[r]);r===0?r=n.length:r==-1&&(r=n.length);var s=e(n[r-1]);this._highLisghtAndScrollTo(i,s)},_selectNext:function(){var t=this.dropList;if(t.css("display")=="none"){this._showDropList();return}var n=this._getAllOptionsAfterFiltered(),r=n.index(this._findHighlightItem()),i=e(n[r]);r==n.length-1&&(r=-1);var s=e(n[r+1]);this._highLisghtAndScrollTo(i,s)},_highLisghtAndScrollTo:function(e,t){var n=this.dropList;e.removeClass("om-state-hover"),t.addClass("om-state-hover"),t.position().top<=0?n.scrollTop(n.scrollTop()+t.position().top):t.position().top+t.outerHeight()>n.height()&&n.scrollTop(n.scrollTop()+t.position().top+t.outerHeight()-n.height())},_backfill:function(t){if(t.length===0)return;var n=this,r=n.element,i=n.dropList,s=n.options,o=s.multi;o?e(t).toggleClass("om-combo-selected").removeClass("om-state-hover"):(this._getAllOptionsBeforeFiltered().removeClass("om-combo-selected"),e(t).addClass("om-combo-selected"));if(i.css("display")=="none")return;var u=[],a=i.find(".om-combo-selected");for(var f=0;f<a.length;f++){var l=e(a[f]).index();l>-1&&u.push(e.data(r,"allValues")[l])}this._setValue(u.join(o?s.multiSeparator:"")),o||i.hide()},_getAllOptionsBeforeFiltered:function(){return this.dropList.find(".om-combo-list-row")},_getAllOptionsAfterFiltered:function(){var e=this.dropList;return e.find(".om-combo-list-row").not(e.find(".om-helper-hidden"))},_doFilter:function(){var t=this,n=t.textInput,r=t.element,i=t.options;records=i.dataSource,filterStrategy=i.filterStrategy,text=n.val(),needShow=!1,items=t._getAllOptionsBeforeFiltered(),allInputText=e.data(r,"allInputText"),e(records).each(function(n){t._filetrPass(filterStrategy,text,records[n],allInputText[n])?(e(items.get(n)).removeClass("om-helper-hidden"),needShow=!0):e(items.get(n)).addClass("om-helper-hidden")});var s=this.dropList.css("height","auto");i.listMaxHeight!="auto"&&s.height()>i.listMaxHeight&&s.height(i.listMaxHeight).css("overflow-y","auto"),needShow||s.hide()},_filetrPass:function(e,t,n,r){if(t==="")return!0;if(typeof e=="function")return e(t,n);if(e==="first")return r.indexOf(t)===0;if(e==="anywhere")return r.indexOf(t)>-1;if(e==="last"){var i=r.lastIndexOf(t);return i>-1&&i+t.length==r.length}return!1},_refeshEmptyText:function(e){var t=this.textInput;if(!e)return;t.val()===""?t.val(e).addClass("om-empty-text"):(t.val()===e&&t.val(""),t.removeClass("om-empty-text"))}})})(jQuery);