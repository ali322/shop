(function(e){e.omWidget("om.omItemSelector",{options:{width:"300px",height:"300px",dataSource:[],value:[],clientFormatter:!1,autoSort:!1,preProcess:function(e){return e},onError:jQuery.noop,onSuccess:jQuery.noop,onBeforeItemSelect:jQuery.noop,onBeforeItemDeselect:jQuery.noop,onItemSelect:jQuery.noop,onItemDeselect:jQuery.noop},_create:function(){this.element.addClass("om-itemselector om-widget").html('<table style="height:100%;width:100%" cellpadding="0" cellspacing="0"><tr><td class="om-itemselector-leftpanel"></td><td class="om-itemselector-toolbar"></td><td class="om-itemselector-rightpanel"></td></tr></table>');var t=e("td",this.element),n=e("<thead></thead>"),r=e("<th></th>").attr({axis:"checkboxCol",align:"center"}).append(e('<div class="header"><span class="checkbox"/><span class="om-itemselector-title"/></div>'));e("<tr></tr>").append(r).appendTo(n),this.leftPanel=e('<table cellspacing="0" cellpadding="0"></table>').append(n).append('<tr><td><div class="om-itemselector-up"><span class="upbtn"/></div><div class="om-itemselector-items"><dl></dl></div><div class="om-itemselector-down"><span class="downbtn"/></div></tr></td>').appendTo(t.eq(0)),this.toolbar=e("<div></div>").appendTo(t.eq(1)),this.rightPanel=this.leftPanel.clone().appendTo(t.eq(2))},_init:function(){var t=this.options,n=t.dataSource;this.leftPanel.find(".om-itemselector-title").html(e.om.lang._get(t,"omItemSelector","availableTitle")),this.rightPanel.find(".om-itemselector-title").html(e.om.lang._get(t,"omItemSelector","selectedTitle")),this.element.css({width:t.width,height:t.height}),this._buildToolbar(),this._resizePanel(),this._bindEvents();if(typeof n=="string"){var r=this;e.ajax({url:n,method:"GET",dataType:"json",success:function(e,n){if(r._trigger("onSuccess",null,e,n)===!1)return;e=t.preProcess(e),t.dataSource=e,r._buildList()},error:function(e,t,n){r._trigger("onError",null,e,t,n)}})}else this._buildList();this._refreshPageButton(this.leftPanel),this._refreshPageButton(this.rightPanel)},_buildToolbar:function(){var t="",n=["add","space","remove"];for(var r=0,i=n.length;r<i;r++){var s=n[r];t+='<div class="om-icon om-itemselector-tbar-'+s+'"'+' title="'+(e.om.lang._get({},"omItemSelector",s+"IconTip")||"")+'"></div>'}this.toolbar.html(t)},_resizePanel:function(){var t=this,n=t.leftPanel,r=t.rightPanel,i=e(".om-itemselector-items",n),s=e(".om-itemselector-items",r),o=n.parent().innerHeight()-i.offset().top+n.offset().top,u=(e("tr",t.element).innerWidth()-t.toolbar.outerWidth())/2,a=n.outerWidth(u).innerWidth();i.outerHeight(o).width(a),s.outerHeight(o).width(a),t.element.data("dltop",e(".om-itemselector-items >dl",n).offset().top)},_buildList:function(){var t=this.options;dataSource=t.dataSource,value=t.value,fmt=t.clientFormatter,leftHtml="",rightHtml="",inArray=function(e,t){for(var n=0,r=t.length;n<r;n++)if(e.value===t[n])return!0;return!1},buildHtml=fmt?function(e,t){return'<dt _index="'+e+'">'+'<span class="checkbox"/>'+fmt(t,e)+"</dt>"}:function(e,t){return'<dt _index="'+e+'">'+'<span class="checkbox"/>'+t.text+"</dt>"},e.isArray(dataSource)&&jQuery.isArray(value)&&e.each(dataSource,function(e,t){inArray(t,value)?rightHtml+=buildHtml(e,t):leftHtml+=buildHtml(e,t)}),e(".om-itemselector-items>dl",this.leftPanel).html(leftHtml),e(".om-itemselector-items>dl",this.rightPanel).html(rightHtml);var n=e(".om-itemselector-items"),r=e(">dl>dt",n).outerHeight(),i=n.outerHeight(),s=r-i%r;n.outerHeight(i+s)},_bindEvents:function(){var t=this,n=t.toolbar;t.leftPanel.delegate(".om-itemselector-items>dl>dt","click.omItemSelector",function(n){e(this).toggleClass("om-state-highlight"),t._refreshHeaderCheckbox(t.leftPanel)}),t.rightPanel.delegate(".om-itemselector-items>dl>dt","click",function(n){e(this).toggleClass("om-state-highlight"),t._refreshHeaderCheckbox(t.rightPanel)}),this.leftPanel.delegate(".om-itemselector-items>dl>dt","dblclick",function(){e(".om-itemselector-items>dl>dt",t.element).removeClass("om-state-highlight"),e(this).addClass("om-state-highlight"),t._moveItemsToTarget(".om-state-highlight",!0)}),this.rightPanel.delegate(".om-itemselector-items>dl>dt","dblclick",function(){e(".om-itemselector-items>dl>dt",t.element).removeClass("om-state-highlight"),e(this).addClass("om-state-highlight"),t._moveItemsToTarget(".om-state-highlight",!1)}),e(".om-itemselector-tbar-add",n).click(function(){t._moveItemsToTarget(".om-state-highlight",!0)}),e(".om-itemselector-tbar-remove",n).click(function(){t._moveItemsToTarget(".om-state-highlight",!1)}),e(".header span.checkbox",t.leftPanel).click(function(){var n=t.leftPanel,r=e(".om-itemselector-items>dl>dt",n);e(this).toggleClass("selected"),e("div.om-itemselector-up:visible",n).length>0&&(r=e(t._getPageItems(n,r))),e(this).hasClass("selected")?r.addClass("om-state-highlight"):r.removeClass("om-state-highlight")}),e(".header span.checkbox",t.rightPanel).click(function(){var n=t.rightPanel,r=e(".om-itemselector-items>dl>dt",n);e(this).toggleClass("selected"),e("div.om-itemselector-up:visible",n).length>0&&(r=e(t._getPageItems(n,r))),e(this).hasClass("selected")?r.addClass("om-state-highlight"):r.removeClass("om-state-highlight")}),t.element.delegate("div.om-itemselector-up:not([disabled])","click",function(){t._page(e(this),!0),t._refreshHeaderCheckbox(e(this).parentsUntil("table").last().parent())}),t.element.delegate("div.om-itemselector-down:not([disabled])","click",function(){t._page(e(this),!1),t._refreshHeaderCheckbox(e(this).parentsUntil("table").last().parent())})},_page:function(e,t){var n=t?e.next():e.prev(),r=n.children("dl"),i=n.outerHeight()-2,s=r.outerHeight(),o=r.offset().top,u,a=this.element.data("dltop")+20;t?(r.offset({top:o+i}),u=n.next(),((o=r.offset().top)>0||r.outerHeight()-o-a>i)&&u.removeAttr("disabled").removeClass("om-itemselector-down-disabled"),o>0&&o<i&&e.attr("disabled","disabled").addClass("om-itemselector-up-disabled")):(r.offset({top:o-i}),u=n.prev(),u.removeAttr("disabled").removeClass("om-itemselector-up-disabled"),(o=r.offset().top)<0&&s+o-a<=i&&e.attr("disabled","disabled").addClass("om-itemselector-down-disabled"))},_refreshHeaderCheckbox:function(t){var n=e(".om-itemselector-items>dl>dt",t);n=e(this._getPageItems(t,n));var r=n.filter(".om-state-highlight").length;e(".header span.checkbox",t).toggleClass("selected",r>0&&n.length===r)},_refreshPageButton:function(t){var n=e(".om-itemselector-items",t),r=e(".om-itemselector-items >dl",t),i=e(".om-itemselector-up",t),s=e(".om-itemselector-down",t),o=n.outerHeight(),u=r.outerHeight(),a=r.offset().top,f=this.element.data("dltop")+20;u>20&&f-a>=u&&(r.offset({top:a+o}),a=r.offset().top),u>o?(i.is(":hidden")&&(n.outerHeight(o-i.outerHeight()*2),i.show(),s.show()),a>0&&a<o?i.attr("disabled","disabled").addClass("om-itemselector-up-disabled"):i.removeAttr("disabled").removeClass("om-itemselector-up-disabled"),a>0||u+a-f>o?s.removeAttr("disabled").removeClass("om-itemselector-down-disabled"):s.attr("disabled","disabled").addClass("om-itemselector-down-disabled")):i.is(":visible")&&(n.outerHeight(o+i.outerHeight()*2),i.hide(),s.hide())},_getPageItems:function(t,n){var r=e(".om-itemselector-items",t),i=r.outerHeight(),s=e(">dl",r),o=[],u=r.next(":visible").length>0,a=n.outerHeight(),f=i/a,l=s.offset().top,c=this.element.data("dltop");return l=u?c-l+20:c-l,o=e.grep(n,function(e,t){return t<f*(l/i+1)-1&&t>=f*(l/i)}),o},select:function(t){e.isArray(indexes)||(indexes=[indexes]);for(var n=0,r=t.length;n<r;n++)e('.om-itemselector-items>dl>dt[_index="'+t[n]+'"]').addClass("om-state-highlight")},_moveItemsToTarget:function(t,n){var r=this,i=n?this.leftPanel:this.rightPanel,s=e(".om-itemselector-items>dl>dt"+t,i);if(s.size()==0)return;var o=n?this.rightPanel:this.leftPanel,u=this.options,a=[];s.each(function(){a.push(u.dataSource[e(this).attr("_index")])});if(n){if(r._trigger("onBeforeItemSelect",null,a)===!1)return;s.appendTo(e(".om-itemselector-items>dl",o)).removeClass("om-state-highlight"),r._trigger("onItemSelect",null,a)}else{if(r._trigger("onBeforeItemDeselect",null,a)===!1)return;s.appendTo(e(".om-itemselector-items>dl",o)).removeClass("om-state-highlight"),r._trigger("onItemDeselect",null,a)}r._refreshHeaderCheckbox(i),r._refreshPageButton(i),r._refreshPageButton(o)},value:function(t){if(arguments.length==0){var n=this.options,r=e(".om-itemselector-items>dl>dt",this.rightPanel),i=[];return r.each(function(){i.push(n.dataSource[e(this).attr("_index")].value)}),i}e.isArray(t)&&(this.options.value=t,this._buildList())}}),e.om.lang.omItemSelector={availableTitle:"可选项",selectedTitle:"已选项",addIconTip:"右移",removeIconTip:"左移"}})(jQuery);