(function(e){var t="om-suggestion-list-row",n="om-state-hover";e.omWidget("om.omSuggestion",{options:{disabled:!1,readOnly:!1,minChars:1,delay:500,cacheSize:10,method:"GET",listMaxHeight:300,queryName:"key",crossDomain:!1,preProcess:function(e,t){return t},onBeforeSuggest:function(e,t){},onSuggesting:function(e,t){},onSuccess:function(e,t,n){},onError:function(e,t,n,r){},onSelect:function(e,t,n,r){}},_create:function(){this.element.addClass("om-suggestion om-widget om-state-default om-state-nobg"),this.dropList=e('<div class="om-widget"><div class="om-widget-content om-droplist"></div></div>').css({position:"absolute",zIndex:2e3}).appendTo(document.body).children().first().hide()},_init:function(){var n=this,r=this.options,i=this.element.attr("autocomplete","off"),s=this.dropList;r.minChars<0&&(r.minChars=0),r.cacheSize<0&&(r.cacheSize=0),r.delay<0&&(r.delay=0),r.disabled?this.disable():this.enable(),r.readOnly?i.attr("readonly","readonly"):i.removeAttr("readonly"),i.focus(function(){e(this).addClass("om-state-focus")}).blur(function(){e(this).removeClass("om-state-focus")}).keydown(function(t){t.keyCode==e.om.keyCode.TAB&&s.hide()}).keyup(function(o){var u=o.keyCode,a=e.om.keyCode;switch(u){case a.DOWN:s.css("display")!=="none"?n._selectNext():s.find("."+t).size()>0&&s.show();break;case a.UP:s.css("display")!=="none"?n._selectPrev():s.find("."+t).size()>0&&s.show();break;case a.ENTER:if(s.css("display")==="none")return;return s.hide(),n._triggerOnSelect(o),!1;case a.ESCAPE:s.hide();break;case a.TAB:break;default:if(r.disabled||r.readOnly)return!1;if(r.delay>0){var f=e.data(i,"delayTimer");f&&clearTimeout(f),f=setTimeout(function(){n._suggest()},r.delay),e.data(i,"delayTimer",f)}else n._suggest()}}).mousedown(function(e){e.stopPropagation()}),s.mousedown(function(e){e.stopPropagation()}),e(document).bind("mousedown.omSuggestion",this.globalEvent=function(){s.hide()})},clearCache:function(){e.removeData(this.element,"cache")},showMessage:function(t){var n=this.element,r=this.dropList.empty().css("height","auto");e("<div>"+t+"<div>").appendTo(r),r.parent().css("left",n.offset().left).css("top",n.offset().top+n.outerHeight());var i=this.options.listWidth;i?i!=="auto"&&r.parent().width(i):r.parent().width(n.outerWidth()),r.show();var s=this.options.listMaxHeight;return s!=="auto"&&r.height()>s&&r.height(s).css("overflow","auto"),this},disable:function(){return this.options.disabled=!0,this.element.attr("disabled","disabled").addClass("om-state-disabled")},enable:function(){return this.options.disabled=!1,this.element.removeAttr("disabled").removeClass("om-state-disabled")},setData:function(e){var t=this.options;e&&(t.dataSource=e),t.cacheSize>0&&this.clearCache()},getData:function(){var t=e.data(this.element,"records");return t||null},getDropList:function(){return this.dropList},destroy:function(){e(document).unbind("mousedown.omSuggestion",this.globalEvent),this.dropList.parent().remove()},_clear:function(){return this.element.val(""),this.dropList.find("."+t).removeClass(n)},_selectNext:function(){var e=this.dropList,t=e.find("."+n).index(),r=this._clear();t+=1,t>=r.size()&&(t=0),this._scrollToAndSelect(r,t,e)},_selectPrev:function(){var e=this.dropList,t=e.find("."+n).index(),r=this._clear();t-=1,t<0&&(t=r.size()-1),this._scrollToAndSelect(r,t,e)},_scrollToAndSelect:function(t,r,i){if(t.size()<1)return;var s=e(t.get(r)).addClass(n),o=s.position().top;if(o<=0)i.scrollTop(i.scrollTop()+o);else{var u=o+s.outerHeight()-i.height();u>0&&i.scrollTop(i.scrollTop()+u)}this._select(r)},_select:function(t){var n=this.element,r=e.data(n,"records"),i,s;r.valueField?(i=r.data[t],s=i[r.valueField]):(i=r[t],s=i),n.val(s),e.data(n,"lastStr",s)},_suggest:function(){var t=this.element,n=t.val(),r=e.data(t,"lastStr");if(r&&r===n)return;e.data(t,"lastStr",n);var i=this.options,s=e.data(t,"cache");if(n.length>0&&n.length>=i.minChars){if(s){var o=s[n];if(o){e.data(t,"records",o),this._buildDropList(o,n);return}}if(i.onBeforeSuggest&&this._trigger("onBeforeSuggest",null,n)===!1){this.dropList.empty().hide();return}var u=this,a={url:i.dataSource,type:i.method,dataType:i.crossDomain?"jsonp":"json",data:{},success:function(r,s){var o=i.onSuccess;if(o&&u._trigger("onSuccess",null,r,s)===!1)return;var a=i.preProcess;a&&(r=a(n,r)),typeof r=="undefined"&&(r=[]);if(i.cacheSize>0){var f=e.data(t,"cache")||{___keys:[]},l=f.___keys;if(l.length==i.cacheSize){var c=l[0];f.___keys=l.slice(1),f[c]=undefined}f[n]=r,f.___keys.push(n),e.data(t,"cache",f)}e.data(t,"records",r),u._buildDropList(r,n)},error:function(e,t,n){var r=i.onError;r&&u._trigger("onError",null,e,t,n)}};a.data[i.queryName]=n,e.ajax(a);var f=i.onSuggesting;f&&u._trigger("onSuggesting",null,n)}else this.dropList.empty().hide()},_buildDropList:function(r,i){var s=this.element,o=this.dropList.empty().css("height","auto"),u=r.valueField?!1:!0,a=this.options.clientFormatter,f=this;u?a?e(r).each(function(e){f._addRow(a(this,e),o)}):e(r).each(function(e){f._addRow(this,o)}):a&&e(r.data).each(function(e){f._addRow(a(this,e),o)});var l=o.find("."+t);if(l.size()>0){o.parent().css("left",parseInt(s.offset().left)).css("top",s.offset().top+s.outerHeight());var c=this.options.listWidth;c?c!=="auto"&&o.parent().width(c):o.parent().width(s.outerWidth()),l.mouseover(function(){l.removeClass(n),e(this).addClass(n)}).mousedown(function(e){var t=o.find("."+n).index();f._select(t),o.hide(),f._triggerOnSelect(e)}),o.show();var h=this.options.listMaxHeight;h!=="auto"&&o.height()>h&&o.height(h).css("overflow","auto"),o.scrollTop(0)}},_addRow:function(n,r){e('<div class="'+t+'">'+n+"</div>").appendTo(r)},_triggerOnSelect:function(t){var r=this.options.onSelect;if(r){var i=this.dropList.find("."+n).index();if(i<0)return;var s=e.data(this.element,"records"),o,u;s.valueField?(o=s.data[i],u=o[s.valueField]):(o=s[i],u=o),this._trigger("onSelect",t,o,u,i)}}})})(jQuery);